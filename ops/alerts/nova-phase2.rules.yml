groups:
  # 1) Slot6 risk signals
  - name: nova-slot6-risk
    interval: 30s
    rules:
      # smoothed view (reusable)
      - record: nova:slot6:p95_residual_risk:max_over_5m
        expr: max_over_time(nova_slot6_p95_residual_risk{slot="6"}[5m])

      - alert: NovaSlot6ResidualRiskWarning
        expr: nova:slot6:p95_residual_risk:max_over_5m > 0.85
        for: 5m
        labels:
          severity: warning
          service: nova
          slot: "6"
        annotations:
          summary: "Slot6 residual risk elevated (p95 > 0.85)"
          description: "Slot6 rolling p95 residual risk = {{ $value | printf \"%.3f\" }} (threshold 0.85) for >5m."
          runbook_url: "ops/runbooks/slot6.md#residual-risk"

      - alert: NovaSlot6ResidualRiskCritical
        expr: nova:slot6:p95_residual_risk:max_over_5m > 0.93
        for: 5m
        labels:
          severity: critical
          service: nova
          slot: "6"
        annotations:
          summary: "Slot6 residual risk CRITICAL (p95 > 0.93)"
          description: "Slot6 rolling p95 residual risk = {{ $value | printf \"%.3f\" }} (threshold 0.93) for >5m."
          runbook_url: "ops/runbooks/slot6.md#residual-risk"

      # exporter silent / metric missing
      - alert: NovaMetricsMissing
        expr: absent(nova_slot6_p95_residual_risk{slot="6"})
        for: 10m
        labels:
          severity: critical
          service: nova
        annotations:
          summary: "NOVA metrics missing"
          description: "nova_slot6_p95_residual_risk not scraped for 10m. Check /metrics gating, app health, and Prometheus scrape config."
          runbook_url: "ops/runbooks/observability.md#prometheus"

  # 2) Feature-flag visibility (treat 0/1 as disabled/enabled)
  - name: nova-feature-flags
    interval: 30s
    rules:
      # Optional: define expected states per env by editing the vector() below
      # Example: in prod you expect Prometheus + Shared Hash ON, TRI/Lifespan OFF:
      - record: nova:expected_flags
        labels:
          NOVA_ENABLE_TRI_LINK: "0"
          NOVA_ENABLE_LIFESPAN: "0"
          NOVA_USE_SHARED_HASH: "1"
          NOVA_ENABLE_PROMETHEUS: "1"
        expr: vector(1)

      # Compare observed flags against their expected values.
      # The expression joins the observed metric with the expected labels,
      # then compares the value of the flag with the value of the 'expected' label.
      - record: nova:feature_flag:unexpected
        expr: |
          nova_feature_flag_enabled != on(flag) group_left(expected) (
            label_replace(nova:expected_flags, "flag", "$1", "NOVA_ENABLE_TRI_LINK", ".*")
            or label_replace(nova:expected_flags, "flag", "$1", "NOVA_ENABLE_LIFESPAN", ".*")
            or label_replace(nova:expected_flags, "flag", "$1", "NOVA_USE_SHARED_HASH", ".*")
            or label_replace(nova:expected_flags, "flag", "$1", "NOVA_ENABLE_PROMETHEUS", ".*")
          )

      - alert: NovaFlagUnexpected
        expr: nova:feature_flag:unexpected == 1
        for: 10m
        labels: { severity: info, service: nova }
        annotations:
          summary: "Feature flag drift detected for '{{ $labels.flag }}'"
          description: "Observed value for '{{ $labels.flag }}' is {{ $value }}, but expected value is {{ $labels.expected }}. Please verify deployment intent."
