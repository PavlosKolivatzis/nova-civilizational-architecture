meta:
  id: nova.operating
  version: 1.0.0
  parents: [nova.frameworks@1.5]
  status: draft
  description: >
    Nova Operating Physics: regimes, posture, hysteresis, amplitude triad, global
    safety envelope, and subsystem obligations built on top of nova.frameworks.

imports:
  - nova.frameworks@1.5

parameters:
  eta_accel_max: 0.1              # Max Δη per 60s (tunable safety param)
  oscillation_window_s: 300       # Oscillation detection window (s)
  downgrade_score_margin: 0.05    # Hysteresis deadband in ORP score space
  recovery_csi_threshold: 0.85    # Exit recovery when CSI >= 0.85

regimes:
  normal:
    ordinal: 0
    description: "Nominal operation; all continuity signals within expected ranges."
    entry_conditions:
      mse_state: [stable]
      urf_composite_risk: "[0.0, 0.3)"
      csi_value: "[0.7, 1.0]"
      logic: AND
    posture_ref: posture.normal
    amplitude_triad_ref: amplitude_triad.normal
    min_duration_s: 60

  heightened:
    ordinal: 1
    description: "Elevated risk; tighter thresholds and mild capacity reduction."
    entry_conditions:
      mse_state: [oscillating]
      urf_composite_risk: "[0.3, 0.6)"
      csi_value: "[0.5, 0.9]"
      logic: AND
    posture_ref: posture.heightened
    amplitude_triad_ref: amplitude_triad.heightened
    min_duration_s: 300

  controlled_degradation:
    ordinal: 2
    description: "Significant instability; controlled capacity reduction and deployment freeze."
    entry_conditions:
      mse_state: [unstable]
      urf_composite_risk: "[0.6, 0.85)"
      csi_value: "[0.3, 0.7]"
      logic: AND
    posture_ref: posture.controlled_degradation
    amplitude_triad_ref: amplitude_triad.controlled_degradation
    min_duration_s: 600

  emergency_stabilization:
    ordinal: 3
    description: "Critical instability; safe_mode bias, strong damping, and hard freezes."
    entry_conditions:
      mse_state: [critically_unstable]
      urf_composite_risk: "[0.85, 1.0]"
      csi_value: "[0.0, 0.5]"
      logic: AND
    posture_ref: posture.emergency_stabilization
    amplitude_triad_ref: amplitude_triad.emergency_stabilization
    min_duration_s: 900

  recovery:
    ordinal: 4
    description: "Post-emergency recovery; gradual return toward normal with minimal learning."
    entry_conditions:
      prior_regime_ordinal: [2, 3]    # Must come from degradation/emergency
      continuity_improving: true      # dC/dt > 0
      csi_value: "[0.5, 0.85)"
      logic: AND
    exit_conditions:
      csi_value: 0.85                 # Recovery threshold from Phase 11
      min_duration_s: 1800
    posture_ref: posture.recovery
    amplitude_triad_ref: amplitude_triad.recovery
    min_duration_s: 1800

posture:
  normal:
    threshold_multiplier: 1.0
    traffic_limit: 1.0
    deployment_freeze: false
    safe_mode_forced: false

  heightened:
    threshold_multiplier: 0.85
    traffic_limit: 0.9
    deployment_freeze: false
    safe_mode_forced: false

  controlled_degradation:
    threshold_multiplier: 0.70
    traffic_limit: 0.60
    deployment_freeze: true
    safe_mode_forced: false

  emergency_stabilization:
    threshold_multiplier: 0.60
    traffic_limit: 0.30
    deployment_freeze: true
    safe_mode_forced: true

  recovery:
    threshold_multiplier: 0.70  # More permissive than emergency
    traffic_limit: 0.50         # Allow 50% traffic during recovery
    deployment_freeze: true
    safe_mode_forced: false     # Gradual normalization

amplitude_triad:
  normal:
    governor_eta_scale: [0.8, 1.0]
    emotion_constriction: 1.0
    slot09_sensitivity_multiplier: 1.0

  heightened:
    governor_eta_scale: [0.75, 0.95]
    emotion_constriction: [0.85, 0.95]              # Duration-dependent from Phase 11
    slot09_sensitivity_multiplier: [1.05, 1.15]     # Duration-dependent from Phase 11

  controlled_degradation:
    governor_eta_scale: [0.50, 0.75]
    emotion_constriction: 0.70
    slot09_sensitivity_multiplier: 1.30

  emergency_stabilization:
    governor_eta_scale: [0.25, 0.50]
    emotion_constriction: 0.50
    slot09_sensitivity_multiplier: 1.50

  recovery:
    governor_eta_scale: [0.25, 0.40]   # Minimal learning during recovery
    emotion_constriction: 0.60
    slot09_sensitivity_multiplier: 1.20

transitions:
  allowed:
    - [normal, heightened]
    - [heightened, normal]
    - [heightened, controlled_degradation]
    - [controlled_degradation, heightened]
    - [controlled_degradation, emergency_stabilization]
    - [emergency_stabilization, recovery]
    - [recovery, heightened]

  forbidden_direct:
    - [normal, emergency_stabilization]
    - [normal, recovery]
    - [heightened, emergency_stabilization]

  min_duration_s:
    normal: 60
    heightened: 300
    controlled_degradation: 600
    emergency_stabilization: 900
    recovery: 1800

hysteresis:
  downgrade_score_margin: 0.05
  max_transitions_per_window:
    count: 3
    window_s: 300
  ledger_window_s: 900

global_safety_envelope:
  - id: no_destructive_oscillation
    description: "No more than 3 regime transitions in any 300s window."
    rule: "count(transitions, window=300s) <= 3"
    maps_to: [phase11_invariants.stability.no_destructive_oscillation]

  - id: no_uncontrolled_acceleration
    description: "Learning rate cannot increase during instability."
    rule: "regime.ordinal >= 1 => eta_multiplier <= 1.0"
    maps_to: [phase11_invariants.stability.no_uncontrolled_acceleration]

  - id: no_noise_amplification
    description: "Detection thresholds cannot decrease during instability."
    rule: "regime.ordinal >= 1 => sensitivity_multiplier >= 1.0"
    maps_to: [phase11_invariants.stability.no_noise_amplification]

  - id: amplitude_bounds
    description: "All amplitude multipliers bounded to safe ranges."
    rule: "0.25 <= eta_scaled <= 1.0 and 0.5 <= emotion <= 1.0 and 1.0 <= sensitivity <= 1.5"
    maps_to: [phase11_invariants.amplitude.bounded_multipliers]

  - id: temporal_inertia
    description: "Children cannot reduce minimum regime durations declared here."
    rule: "forall child: min_duration_child[regime] >= min_duration_operating[regime]"
    maps_to: [phase11_invariants.temporal.minimum_regime_durations]

  - id: continuity_preservation
    description: "Continuity score (CSI) remains within [0,1] at all times."
    rule: "0.0 <= csi_value <= 1.0"
    signal_ref: nova.frameworks.ContinuityStabilityIndex
    maps_to: [phase11_invariants.stability.no_continuity_collapse]

  - id: recovery_path_guarantee
    description: "Every regime has a defined path back to normal."
    rule: "forall r in regimes: graph.has_path(r, normal)"
    maps_to: [phase11_invariants.emergent.recovery_graduality]

contracts:
  transformation_geometry:
    ref: transformation_geometry@1
    version: 1.0.0
    scope:
      states: [normal, heightened, controlled_degradation, emergency_stabilization, recovery]
      uses:
        - transitions.allowed
        - transitions.min_duration_s
        - hysteresis.max_transitions_per_window
        - amplitude_triad
        - global_safety_envelope

implementation_refs:
  orp_classification: src.nova.continuity.orp_policy.classify_regime
  eta_scaling: src.nova.continuity.eta_scaling.apply_eta_scaling
  emotional_constriction: src.nova.continuity.emotional_posture.apply_emotional_constriction
  sensitivity_scaling: src.nova.continuity.slot09_sensitivity.apply_sensitivity_scaling
  hysteresis: src.nova.continuity.orp_hysteresis.check_regime_hysteresis
  regime_ledger: src/nova/continuity/regime_transitions.jsonl

subsystem_obligations:
  slot03_emotional_matrix:
    per_regime:
      emergency_stabilization:
        emotion_constriction_ref: amplitude_triad.emergency_stabilization.emotion_constriction
        enforcement: child_ontology  # nova.slot03@1.0

  slot07_production_controls:
    per_regime:
      controlled_degradation:
        threshold_multiplier_ref: posture.controlled_degradation.threshold_multiplier
        enforcement: child_ontology  # nova.slot07@1.0

  slot09_distortion_protection:
    per_regime:
      emergency_stabilization:
        sensitivity_multiplier_ref: amplitude_triad.emergency_stabilization.slot09_sensitivity_multiplier
        enforcement: child_ontology  # nova.slot09@1.0

  slot10_gatekeeper:
    per_regime:
      controlled_degradation:
        deployments_allowed: false
        enforcement: child_ontology  # nova.slot10@1.0
      emergency_stabilization:
        deployments_allowed: false
        rollback_recommended: true
        enforcement: child_ontology  # nova.slot10@1.0

  governor_adaptive_wisdom:
    per_regime:
      emergency_stabilization:
        eta_scale_ref: amplitude_triad.emergency_stabilization.governor_eta_scale
        enforcement: implementation  # governor implementation enforces this mapping
