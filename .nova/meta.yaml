# Nova Civilizational Architecture — System Metadata
# This file is the entry point for all agents, CLI tools, and external systems.
# It reflects Nova's current state and provides navigation to the architecture.
#
# Maintenance: Semi-automated
# - Slot map, docs paths: hand-curated (stable)
# - Runtime state (commit, maturity, tests): generated by tools/nova-welcome.sh
# - Update when: new slots added, docs reorganized, major phase transitions
#
# Philosophy: This file demonstrates Nova principles while teaching them.
# - Provenance: Links to sources of truth (git, maturity.yaml, audit reports)
# - Immutability: Metadata is versioned; changes produce new commits
# - Observability: Points to runtime introspection endpoints
# - Reversibility: No behavioral logic here; pure navigation

meta:
  schema_version: "1.0.0"
  last_updated: "2025-12-05"
  maintainer: "Nova Core Team"
  purpose: "Active map of Nova's architecture, ontology, and runtime state"

system:
  name: "Nova Civilizational Architecture"
  tagline: "Observe → Canonize → Attest → Publish"
  description: >
    A 10-slot AI governance system implementing provenance-first,
    immutable attestation, and civilizational-scale safety protocols.

  phase: "Phase 14.2 - PostgreSQL Persistence & Merkle Checkpoints"
  maturity_level: "4.0 (Processual)"
  status: "stable"

# ============================================================================
# ONTOLOGY — The Nova Way of Thinking
# ============================================================================

ontology:
  rule_of_sunlight: "Observe → Canonize → Attest → Publish"

  core_invariants:
    - name: "Separation of Roles"
      rule: "Slots interpret; Core attests; never collapse the boundary"
    - name: "Provenance First"
      rule: "Cite inputs, assumptions, confidence; no orphaned claims"
    - name: "Immutability at Attest"
      rule: "Same canonical body → same digest; corrections are new events"
    - name: "Reversibility by Default"
      rule: "Feature flags, fast rollback; off-by-default for risky changes"
    - name: "Transparent Uncertainty"
      rule: "Label ignorance; don't hide gaps with false confidence"
    - name: "Observability Always"
      rule: "Export metrics; no SSH spelunking; failures visible in sunlight"

  three_ledgers:
    fact_ledger:
      purpose: "Raw observations, append-only"
      example: "git commits, sensor readings, user events"
    claim_ledger:
      purpose: "Slot interpretations with assumptions + confidence"
      example: "Slot2 ΔTHRESH analysis, Slot6 cultural synthesis"
    attest_ledger:
      purpose: "Hash-linked, optionally signed events (tamper-evident)"
      example: "Slot1 truth anchors, Slot9 audit chains"

  primer: "agents/nova_ai_operating_framework.md"

# ============================================================================
# LEARNING PATH — How to Understand Nova Deeply
# ============================================================================

learning_path:
  phase1_orientation:
    goal: "Understand Nova's mental model and architectural boundaries"
    duration: "~15 minutes"
    why: "Build foundational ontology before touching code"
    steps:
      - step: 1
        action: "read"
        file: ".claude/agent.md"
        focus: ["Rule of Sunlight", "10 invariants", "WDL integration", "Progressive Understanding Protocol"]
        note: "Nova operator cognitive framework (for AI agents working ON Nova). Detailed operational protocols."
      - step: 2
        action: "read"
        file: "agents/nova_ai_operating_framework.md"
        focus: ["Rule of Sunlight", "3 ledgers", "6 invariants", "first 10min checklist"]
        note: "System architecture overview (for external agents working WITH Nova). The Rosetta Stone."
      - step: 3
        action: "read"
        file: "docs/architecture.md"
        focus: ["10 slot map", "orchestrator role", "inter-slot contracts"]
        note: "See how philosophy manifests in structure"
      - step: 4
        action: "read"
        file: "docs/slots/*.md"
        focus: ["Each slot's purpose", "contract stability", "inter-dependencies"]
        note: "Read in order: slot01 → slot02 → ... → slot10"
    checkpoint:
      verify_understanding:
        - "Can you explain the Rule of Sunlight in your own words?"
        - "What are the 3 ledgers and why are they separated?"
        - "Name all 6 invariants without looking"
        - "Draw the 10-slot architecture from memory"
        - "Explain: Why can't slots attest directly?"
      test_yourself:
        - "Open a random slot meta.yaml and identify its contracts"
        - "Trace a hypothetical event: user input → which slots → attestation"

  phase2_introspection:
    goal: "Probe current system state and verify understanding"
    duration: "~10 minutes"
    why: "Theory → Code. See how abstractions are implemented."
    steps:
      - step: 1
        action: "read"
        file: "src/nova/slots/*/meta.yaml"
        focus: ["Slot versions", "feature flags", "contract schemas", "dependencies"]
        note: "These are EXECUTABLE specs. Slots self-describe."
      - step: 2
        action: "read"
        file: "orchestrator/app.py"
        focus: ["Slot registration", "lifespan manager", "error boundaries"]
        note: "The orchestrator is thin glue. Slots do the work."
      - step: 3
        action: "run"
        command: "pytest -q -m 'not slow'"
        expect: "2021 tests passing (2117 collected, current baseline)"
        note: "Tests are documentation. Read failures to understand boundaries."
      - step: 4
        action: "run"
        command: "./tools/maturity.sh"
        expect: "overall: 4.0, all slots Processual"
        note: "Maturity = operational capability, not code volume"
    checkpoint:
      verify_understanding:
        - "What is the difference between a slot's meta.yaml and its implementation?"
        - "How does the orchestrator discover slots at runtime?"
        - "Why are tests the highest maturity indicator (not LOC)?"
        - "Name 3 feature flags and what they gate"
      test_yourself:
        - "Add a print statement to orchestrator/app.py, restart, verify it runs"
        - "Run a single slot's tests: pytest tests/test_slot01* -v"
        - "Find where NOVA_ENABLE_PROMETHEUS is checked in code"

  phase3_observability:
    goal: "Understand runtime metrics and health monitoring"
    duration: "~10 minutes"
    why: "Sunlight = observability. See how Nova watches itself."
    steps:
      - step: 1
        action: "read"
        file: "orchestrator/prometheus_metrics.py"
        focus: ["Metric naming (nova_slotN_*)", "flag gauges", "slot health"]
        note: "Metrics are the nervous system. No hidden state."
      - step: 2
        action: "read"
        file: "src/nova/slots/slot07_production_controls/flag_metrics.py"
        focus: ["Feature flag observability", "runtime introspection"]
        note: "Flags themselves are observable (meta-observability)"
      - step: 3
        action: "run"
        command: "NOVA_ENABLE_PROMETHEUS=1 uvicorn orchestrator.app:app"
        then: "curl localhost:8000/metrics | grep nova_"
        expect: "Prometheus metrics with flag states, slot health"
        note: "Metrics disabled by default (flag=0). This is reversibility."
    checkpoint:
      verify_understanding:
        - "Why are metrics behind a feature flag instead of always-on?"
        - "What does nova_feature_flag_enabled{flag='X'} tell you?"
        - "How would you add a new metric to Slot02?"
      test_yourself:
        - "Find a metric in /metrics and trace it back to source code"
        - "Toggle NOVA_ENABLE_PROMETHEUS=0, verify /metrics returns 404"
        - "Read a slot's metrics.py and predict what appears in /metrics"

  phase4_change_protocol:
    goal: "Learn how to propose reversible, sunlight-safe changes"
    duration: "~10 minutes"
    why: "Now you understand Nova. Learn how to evolve it safely."
    steps:
      - step: 1
        action: "read"
        file: "agents/nova_ai_operating_framework.md"
        section: "Change policy (§5), Pre-merge checklist (§11)"
        note: "Off-by-default, flag-gated, reversible. No exceptions."
      - step: 2
        action: "read"
        file: ".env.example"
        focus: ["NOVA_* feature flags", "default states (0=off)"]
        note: "Every flag starts at 0. Opt-in only."
      - step: 3
        action: "experiment"
        task: "Add a new flag, gate behavior, write test, verify rollback"
        note: "This is the final exam. Can you make a sunlight-safe change?"
      - step: 4
        action: "verify"
        test: "Toggle flag → behavior reverts without code changes"
        note: "If you need code changes to revert, the flag is broken."
    checkpoint:
      verify_understanding:
        - "Why must flags default to 0 (off)?"
        - "What's the difference between a flag and a config value?"
        - "How do you test both flag=0 and flag=1 paths in CI?"
      test_yourself:
        - "Add NOVA_ENABLE_EXAMPLE_FEATURE=0 to .env.example"
        - "Gate a simple behavior (e.g., log message) behind this flag"
        - "Write a test that verifies both flag states"
        - "Toggle flag, restart, confirm behavior change"
        - "Set flag=0, confirm revert to original behavior"

  phase5_synthesis:
    goal: "Build a complete mental model and verify architectural understanding"
    duration: "~30 minutes"
    why: "Integration test for your brain. Can you think like Nova now?"
    steps:
      - step: 1
        action: "draw"
        task: "Sketch the full architecture from memory (no peeking)"
        include: ["10 slots", "orchestrator", "contracts", "attestation flow"]
        note: "If you can't draw it, you don't understand it yet."
      - step: 2
        action: "trace"
        task: "Pick a user action and trace it end-to-end"
        example: "User submits text → Slot02 detects ΔΣΘΩ → Slot01 anchors → Slot09 audits"
        note: "Follow data flow: input → slots → ledgers → output"
      - step: 3
        action: "explain"
        task: "Teach Nova to someone else (real or imaginary)"
        topics: ["Rule of Sunlight", "Why 3 ledgers?", "Why slots can't attest?"]
        note: "If you can teach it, you've internalized it."
      - step: 4
        action: "critique"
        task: "Find 3 things Nova does well and 3 gaps/risks"
        use: ".artifacts/audit_master_summary.md for gaps"
        note: "Honest assessment proves understanding > cheerleading."
    checkpoint:
      verify_mastery:
        - "Explain Nova's core innovation in 2 sentences"
        - "What would break if we merged ledgers 1 and 2?"
        - "Design a new Slot11. What contracts would it need?"
        - "Propose a test for an untested edge case"
        - "Identify a failure mode not covered by current safeguards"
      final_exam:
        - "Read a random code file you haven't seen yet"
        - "Predict: Which slot owns this? What contracts does it use?"
        - "Verify your prediction by reading meta.yaml + tests"
        - "If wrong, explain WHY you were wrong (updates mental model)"

# ============================================================================
# ARCHITECTURE — Canonical Slot Map
# ============================================================================

slots:
  slot01:
    name: "Truth Anchor"
    slug: "slot01_truth_anchor"
    purpose: "Foundational truth anchoring with cryptographic RealityLock"
    doc: "docs/slots/slot01_truth_anchor.md"
    meta: "src/nova/slots/slot01_truth_anchor/meta.yaml"
    maturity: 4.0
    contracts_provided: ["anchor.compute", "anchor.verify", "anchor.recover"]

  slot02:
    name: "ΔTHRESH Integration Manager"
    slug: "slot02_deltathresh"
    purpose: "ΔΣΘΩ pattern detection, TRI calculation, adaptive thresholds"
    doc: "docs/slots/slot02_deltathresh.md"
    maturity: 4.0
    contracts_provided: ["delta.analyze", "tri.compute"]

  slot03:
    name: "Emotional Matrix"
    slug: "slot03_emotional_matrix"
    purpose: "Emotional state analysis and affective computing"
    doc: "docs/slots/slot03_emotional_matrix.md"
    maturity: 4.0
    contracts_provided: ["emotion.analyze"]

  slot04:
    name: "TRI Engine"
    slug: "slot04_tri"
    purpose: "Trust-Reciprocity-Integrity scoring and constellation linking"
    doc: "docs/slots/slot04_tri.md"
    meta: "src/nova/slots/slot04_tri/meta.yaml"
    maturity: 4.0
    contracts_provided: ["tri.score", "tri.validate"]
    feature_flags: ["NOVA_ENABLE_TRI_LINK"]

  slot05:
    name: "Constellation"
    slug: "slot05_constellation"
    purpose: "Multi-agent coordination and federated truth consensus"
    doc: "docs/slots/slot05_constellation.md"
    meta: "src/nova/slots/slot05_constellation/meta.yaml"
    maturity: 4.0
    contracts_provided: ["constellation.register", "constellation.query"]

  slot06:
    name: "Cultural Synthesis"
    slug: "slot06_cultural_synthesis"
    purpose: "Cross-cultural pattern analysis and synthesis"
    doc: "docs/slots/slot06_cultural_synthesis.md"
    maturity: 4.0
    contracts_provided: ["culture.analyze", "culture.synthesize"]

  slot07:
    name: "Production Controls"
    slug: "slot07_production_controls"
    purpose: "Feature flags, circuit breakers, operational safety gates"
    doc: "docs/slots/slot07_production_controls.md"
    maturity: 4.0
    contracts_provided: ["flags.check", "circuit.trip"]

  slot08:
    name: "Memory Ethics Guard"
    slug: "slot08_memory_lock"
    purpose: "Ethical memory handling and consent enforcement"
    doc: "docs/slots/slot08_memory_guard.md"
    maturity: 4.0
    contracts_provided: ["memory.store", "memory.recall", "consent.check"]

  slot09:
    name: "Distortion Protection"
    slug: "slot09_distortion_protection"
    purpose: "Adversarial detection, audit chain integrity"
    doc: "docs/slots/slot09_distortion_protection.md"
    meta: "src/nova/slots/slot09_distortion_protection/meta.yaml"
    maturity: 4.0
    contracts_provided: ["distortion.detect", "audit.verify"]
    feature_flags: ["NOVA_USE_SHARED_HASH"]

  slot10:
    name: "Civilizational Deployment"
    slug: "slot10_civilizational_deployment"
    purpose: "Consent profiles, deployment ethics, civilizational-scale safety"
    doc: "docs/slots/slot10_civilizational_deployment.md"
    meta: "src/nova/slots/slot10_civilizational_deployment/meta.yaml"
    maturity: 4.0
    contracts_provided: ["consent.validate", "deployment.authorize"]

# ============================================================================
# RUNTIME INTROSPECTION — Where to Look for Live State
# ============================================================================

runtime:
  git:
    command: "git log -1 --format='%h %ai %s'"
    provides: ["current commit", "timestamp", "phase label"]

  maturity:
    command: "npm run maturity"
    schema: "docs/maturity.yaml"
    provides: ["overall score (0-4)", "per-slot maturity", "test counts"]

  audit:
    latest_report: ".artifacts/audit_master_summary.md"
    date: "2025-11-13"
    phase: "Phase 16.2"
    findings: ["1 CRITICAL auth issue", "7 CVEs", "0% rate-limit coverage"]

  tests:
    command: "pytest -q -m 'not slow'"
    expected_pass_count: 2021
    total_collected: 2117
    coverage_target: "85% (configurable thresholds; current >95%)"

  metrics:
    endpoint: "http://localhost:8000/metrics"
    enabled_by: "NOVA_ENABLE_PROMETHEUS=1"
    naming_convention: "nova_slotN_* for slot-specific, nova_* for system-wide"
    examples:
      - "nova_feature_flag_enabled{flag='NOVA_ENABLE_TRI_LINK'}"
      - "nova_slot1_anchor_count"
      - "nova_slot6_p95_residual_risk"

  feature_flags:
    registry: ".env.example"
    convention: "NOVA_ENABLE_* / NOVA_USE_*"
    default_state: "0 (off)"
    observability: "Exposed via Prometheus flag_metrics when NOVA_ENABLE_PROMETHEUS=1"
    known_flags:
      - NOVA_ENABLE_TRI_LINK
      - NOVA_ENABLE_LIFESPAN
      - NOVA_USE_SHARED_HASH
      - NOVA_ENABLE_PROMETHEUS
      - NOVA_ENABLE_META_LENS
      - NOVA_ENABLE_CREATIVITY_METRICS
      - NOVA_ENABLE_PROBABILISTIC_CONTRACTS

# ============================================================================
# AGENT PROTOCOL — How External Agents Should Behave
# ============================================================================

agent_protocol:
  consent_required: true
  default_mode: "read_only"
  escalation_path: "Request CONSENT_PROFILE from Slot10 before write operations"

  entry_flow:
    step1: "Run tools/nova-welcome.sh (prints this metadata + live state)"
    step2: "Follow learning_path.phase1_orientation"
    step3: "Declare capabilities and consent profile to Slot10"
    step4: "Receive scoped access credentials"
    step5: "Operate within granted scope; log all actions to attest ledger"

  sunlight_enforcement:
    - "All agent actions must be observable (logged, metered, auditable)"
    - "No hidden side-channels or bypass mechanisms"
    - "Failures are visible; no silent degradation"
    - "Consent can be revoked; agents must handle graceful shutdown"

  self_introduction_template:
    agent_id: "uuid or stable identifier"
    capabilities: ["list of skills/tools"]
    consent_profile: "CE001.standard | CE002.restricted | custom"
    provenance: "organization, version, audit trail"

# ============================================================================
# DOCUMENTATION INDEX — Where to Find Deep Knowledge
# ============================================================================

docs:
  architecture:
    - path: "docs/architecture.md"
      topics: ["10-slot system map", "orchestrator", "plugin model"]
    - path: "docs/architecture/SYSTEM_ARCHITECTURE.md"
      topics: ["detailed design", "inter-slot flows"]

  contracts:
    - path: "docs/INTERSLOT_CONTRACTS.md"
      topics: ["contract stability levels", "versioning policy"]
    - path: "docs/CONTRACT_VERSIONING.md"
      topics: ["breaking changes", "schema evolution"]

  operations:
    - path: "docs/RUNBOOKS.md"
      topics: ["incident response", "operational procedures"]
    - path: "docs/ops/observability.md"
      topics: ["monitoring setup", "dashboard imports", "alert rules"]

  releases:
    - path: "docs/releases/"
      topics: ["phase changelogs", "migration guides"]

  reflections:
    - path: "docs/reflections/"
      topics: ["philosophical evolution", "design decisions", "wisdom integration"]

# ============================================================================
# CHANGELOG — Evolution of This Metadata File
# ============================================================================

changelog:
  - version: "1.0.0"
    date: "2025-11-17"
    changes: "Initial active map: ontology, learning path, slot canon, agent protocol"
    rationale: "Agent entry protocol needed self-aware navigation index"
