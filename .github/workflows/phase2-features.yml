name: Phase 2 Feature Gates

on:
  push:
    branches: [ main, 'feature/tri-engine-integration' ]
  pull_request:
    branches: [ main ]

jobs:
  test-feature-gates:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false                # don't cancel other lanes if one fails
      matrix:
        include:
          - name: "baseline"
            env:
              NOVA_ENABLE_TRI_LINK: "0"
              NOVA_ENABLE_LIFESPAN: "0"
              NOVA_USE_SHARED_HASH: "0"
          - name: "phase2-tri-hash"
            env:
              NOVA_ENABLE_TRI_LINK: "1"
              NOVA_ENABLE_LIFESPAN: "0"
              NOVA_USE_SHARED_HASH: "1"
          - name: "phase2-lifespan"
            env:
              NOVA_ENABLE_TRI_LINK: "0"
              NOVA_ENABLE_LIFESPAN: "1"
              NOVA_USE_SHARED_HASH: "0"
          - name: "observability-prom"            env:              NOVA_ENABLE_TRI_LINK: "0"              NOVA_ENABLE_LIFESPAN: "0"              NOVA_USE_SHARED_HASH: "0"              NOVA_ENABLE_PROMETHEUS: "1"
    name: pytest (${{ matrix.name }})
    env: ${{ matrix.env }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Prefer editable install with test extras if available; falls back to requirements.txt
        if [ -f setup.cfg ] || [ -f pyproject.toml ]; then
          pip install -e .[test] || true
        fi
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        # Ensure FastAPI stack for lifespan tests (in case not included above)
        python - <<'PY'
        import importlib.util, sys
        missing = [m for m in ("fastapi","starlette","httpx","prometheus_client") if importlib.util.find_spec(m) is None]
        if missing:
            print("Installing missing test deps:", missing)
            import subprocess
            subprocess.check_call([sys.executable, "-m", "pip", "install", *missing])
        PY

    - name: Check environment flags
      run: env | sort | grep -E '^NOVA_' || echo "No NOVA flags set"

    - name: Run full test suite
      run: pytest -q -m "not slow"

    # Prove flags actually trigger gated paths (only when enabled)
    - name: Targeted TRIâ†”Constellation e2e (flagged lane)
      if: ${{ matrix.env.NOVA_ENABLE_TRI_LINK == '1' }}
      run: pytest -q tests/e2e/test_constellation_with_tri.py

    - name: Targeted lifespan tests (flagged lane)
      if: ${{ matrix.env.NOVA_ENABLE_LIFESPAN == '1' }}
      run: pytest -q tests/web/test_lifespan.py

    - name: Targeted shared-hash tests (flagged lane)
      if: ${{ matrix.env.NOVA_USE_SHARED_HASH == '1' }}
      run: pytest -q tests/test_slot09_shared_hash_coverage.py::test_audit_hash_chain_with_shared_hash_enabled
n    - name: Targeted Prometheus route (flagged lane)
      if: ${{ matrix.env.NOVA_ENABLE_PROMETHEUS == '1' }}
      run: pytest -q tests/web/test_prometheus_route.py

    - name: Targeted Slot7 metrics smoke
      run: python -c "from orchestrator.adapters.slot7_production_controls import Slot7ProductionControlsAdapter; ad=Slot7ProductionControlsAdapter(); out=ad.process({'action':'get_metrics'}); assert isinstance(out,dict); m=out.get('metrics') or out.get('result',{}).get('metrics',{}) or {}; ff=(m.get('feature_flags') or out.get('feature_flags') or out.get('result',{}).get('feature_flags',{})); assert isinstance(ff,dict) and 'effective_hash_method' in ff; print('Slot7 metrics smoke test passed')"

    - name: Feature gate validation summary
      run: |
        echo "ðŸŽ¯ Phase 2 Feature Gate Validation (${{ matrix.name }})"
        echo "============================================="
        echo "TRIâ†”Constellation: ${{ matrix.env.NOVA_ENABLE_TRI_LINK }}"
        echo "Lifespan Manager: ${{ matrix.env.NOVA_ENABLE_LIFESPAN }}"
        echo "Shared Hash:      ${{ matrix.env.NOVA_USE_SHARED_HASH }}"