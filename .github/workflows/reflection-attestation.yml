name: Reflection Attestation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"  # nightly sanity

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  reflect:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      NOVA_REFLECTION_SECRET: ${{ secrets.NOVA_REFLECTION_SECRET }}
      PYTHONUNBUFFERED: "1"
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Reflection snapshot (no server needed)
        run: |
          PYTHONPATH=src python - <<'PY'
          import os, json, math, hmac, hashlib
          from nova.orchestrator.reflection import nova_reflect

          snap = nova_reflect()

          # --- HMAC attestation (gracefully skip if not present) ---
          prov = snap.get("provenance") or {}
          payload = dict(snap); payload.pop("provenance", None)
          blob = json.dumps(payload, sort_keys=True, separators=(",", ":")).encode()
          secret = os.environ.get("NOVA_REFLECTION_SECRET", "nova-reflection-default-key").encode()
          sig_ok = bool(prov) and hmac.compare_digest(
              hmac.new(secret, blob, hashlib.sha256).hexdigest(),
              prov.get("hmac_sha256","")
          )
          print("HMAC:", "OK" if sig_ok else "SKIPPED")

          # --- Pull observation / ANR ---
          obs = snap.get("observation", {})
          anr = obs.get("anr_probe", {})

          # --- Safe-normalize probs ---
          probs = {}
          if isinstance(anr.get("probs"), dict):
              for k, v in anr["probs"].items():
                  try:
                      f = float(v)
                      if math.isfinite(f) and f >= 0:
                          probs[str(k)] = f
                  except Exception:
                      pass
          s = sum(probs.values())
          if s > 0:
              for k in list(probs.keys()):
                  probs[k] /= s

          n = len(probs)

          # --- Entropy (bits), prefer payload field, else recompute ---
          H_bits = anr.get("entropy_bits", anr.get("entropy", None))
          if not isinstance(H_bits, (int, float)) or H_bits < 0:
              H_bits = (-sum(p * math.log(p, 2) for p in probs.values() if p > 0)) if n > 1 else 0.0
          H_max = math.log(n, 2) if n > 1 else 0.0

          # --- Decisiveness (prefer payload, else 1 - H/Hmax) ---
          dec = anr.get("decisiveness", None)
          if not isinstance(dec, (int, float)):
              dec = (1.0 - H_bits / H_max) if H_max > 0 else 1.0
          dec = max(0.0, min(1.0, float(dec)))

          slots_ok = int(obs.get("slots_ok", 0))
          slots_total = max(1, int(obs.get("slots_total", 1)))
          flow_status = (obs.get("flow_fabric") or {}).get("status", "unknown")

          # --- Thresholds (env-tunable) ---
          MIN_DEC = float(os.getenv("NOVA_CI_DECISIVENESS_MIN", "0.55"))
          MAX_H   = float(os.getenv("NOVA_CI_MAX_ENTROPY_BITS", "1.50"))
          ALLOW_COLDSTART = os.getenv("NOVA_CI_ALLOW_COLDSTART", "1") == "1"

          # --- Cold-start detection: near-uniform distribution ---
          near_uniform = (n > 1 and H_max > 0 and abs(H_bits - H_max) <= 1e-3)
          healthy_overall = (slots_ok / slots_total) >= 0.90 and flow_status in ("healthy", "unknown")

          print(f"Decisiveness: {dec:.3f}")
          if dec < MIN_DEC:
              if ALLOW_COLDSTART and near_uniform and healthy_overall:
                  print("⚠️  Cold-start uniform policy detected — decisiveness check waived for this snapshot.")
              else:
                  raise AssertionError(f"Decisiveness too low: {dec:.3f}")

          print(f"Entropy (bits): {H_bits:.3f}  H_max: {H_max:.3f}")
          if H_bits > MAX_H:
              if ALLOW_COLDSTART and near_uniform and healthy_overall:
                  print("⚠️  Cold-start uniform policy detected — entropy check waived for this snapshot.")
              else:
                  raise AssertionError(f"Entropy too high: {H_bits:.3f}")

          print(f"Slots: {slots_ok}/{slots_total}")
          assert (slots_ok / slots_total) >= 0.90, f"Slots below 90% healthy: {slots_ok}/{slots_total}"

          print(f"Flow: {flow_status}")
          assert flow_status in ("healthy", "unknown"), f"Flow fabric status: {flow_status}"

          print("All checks passed.")

          # Emit summary
          print(json.dumps({
              "snapshot_id": snap.get("snapshot_id", "unknown"),
              "decisiveness": dec,
              "entropy_bits": H_bits,
              "slots_ok": slots_ok,
              "slots_total": slots_total,
              "flow_status": flow_status,
              "cold_start_detected": near_uniform,
            }, indent=2))
          PY

      - name: Upload reflection artifact
        if: always()
        run: |
          mkdir -p artifacts
          PYTHONPATH=src python - <<'PY' > artifacts/reflection.json
          import json
          from nova.orchestrator.reflection import nova_reflect
          print(json.dumps(nova_reflect(), ensure_ascii=False, indent=2))
          PY
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: reflection-snapshot
          path: artifacts/reflection.json
