name: Reflection Attestation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"  # nightly sanity

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  reflect:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      NOVA_REFLECTION_SECRET: ${{ secrets.NOVA_REFLECTION_SECRET }}
      PYTHONUNBUFFERED: "1"
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Reflection snapshot (no server needed)
        run: |
          PYTHONPATH=. python - <<'PY'
          import os, json, hmac, hashlib, math
          from orchestrator.reflection import nova_reflect

          def _safe_probs(d):
              if not isinstance(d, dict):
                  return {}
              out = {}
              for k, v in d.items():
                  try:
                      f = float(v)
                      if math.isfinite(f) and f >= 0:
                          out[str(k)] = f
                  except Exception:
                      pass
              s = sum(out.values())
              if s > 0:
                  for k in list(out.keys()):
                      out[k] = out[k] / s
              return out

          def _decisiveness(anr: dict) -> float:
              # prefer payload value if present and valid
              dv = anr.get("decisiveness", None)
              if isinstance(dv, (int, float)) and 0 <= dv <= 1:
                  return float(dv)

              probs = _safe_probs(anr.get("probs", {}))
              n = len(probs)
              if n <= 1:
                  return 1.0  # degenerate: single route => fully decisive

              # try payload entropy (bits) if present
              H_bits = anr.get("entropy_bits", anr.get("entropy", None))
              if isinstance(H_bits, (int, float)) and H_bits >= 0:
                  return max(0.0, min(1.0, 1.0 - (H_bits / math.log(n, 2))))

              # recompute from probs
              H = -sum(p * math.log(p, 2) for p in probs.values() if p > 0)
              Hmax = math.log(n, 2)
              return max(0.0, min(1.0, 1.0 - H / Hmax))

          def _hmac_ok(snap: dict) -> bool:
              payload = dict(snap)
              payload.pop("provenance", None)
              blob = json.dumps(payload, sort_keys=True, separators=(",", ":")).encode()
              secret = os.environ.get("NOVA_REFLECTION_SECRET", "nova-reflection-default-key").encode()
              expected = hmac.new(secret, blob, hashlib.sha256).hexdigest()
              got = (snap.get("provenance") or {}).get("hmac_sha256", "")
              return hmac.compare_digest(expected, got)

          snap = nova_reflect()

          # 1) Attestation
          if not _hmac_ok(snap):
              raise SystemExit("HMAC verification failed")

          # 2) Guardrails (schema-agnostic)
          obs = snap.get("observation", {})
          anr = obs.get("anr_probe", {})
          dec = _decisiveness(anr)

          slots_ok = int(obs.get("slots_ok", 0))
          slots_total = max(1, int(obs.get("slots_total", 1)))
          flow_status = (obs.get("flow_fabric") or {}).get("status", "unknown")

          print(f"Decisiveness: {dec:.3f}")
          assert dec >= 0.55, f"Decisiveness too low: {dec:.3f}"

          # entropy (prefer bits, fall back)
          probs = _safe_probs(anr.get("probs", {}))
          H_bits = anr.get("entropy_bits", anr.get("entropy", None))
          if not isinstance(H_bits, (int, float)):
              # recompute if absent
              H_bits = -sum(p * math.log(p, 2) for p in probs.values() if p > 0)
          print(f"Entropy (bits): {H_bits:.3f}")
          assert H_bits <= 1.50, f"Entropy too high: {H_bits:.3f}"

          print(f"Slots: {slots_ok}/{slots_total}")
          assert (slots_ok / slots_total) >= 0.90, f"Slots below 90% healthy: {slots_ok}/{slots_total}"

          print(f"Flow status: {flow_status}")
          assert flow_status in ("healthy", "unknown"), f"Flow fabric status: {flow_status}"

          print("All checks passed.")

          # Emit summary
          print(json.dumps({
              "snapshot_id": snap.get("snapshot_id", "unknown"),
              "decisiveness": dec,
              "entropy_bits": H_bits,
              "slots_ok": slots_ok,
              "slots_total": slots_total,
              "flow_status": flow_status,
            }, indent=2))
          PY

      - name: Upload reflection artifact
        if: always()
        run: |
          mkdir -p artifacts
          PYTHONPATH=. python - <<'PY' > artifacts/reflection.json
          import json
          from orchestrator.reflection import nova_reflect
          print(json.dumps(nova_reflect(), ensure_ascii=False, indent=2))
          PY
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: reflection-snapshot
          path: artifacts/reflection.json