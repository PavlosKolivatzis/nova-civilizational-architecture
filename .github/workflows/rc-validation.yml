name: "Phase 7.0-RC Validation"

on:
  schedule:
    - cron: '0 10 * * 1'  # Weekly Monday 10:00 UTC
  workflow_dispatch:
    inputs:
      manual_trigger:
        description: 'Manual RC validation'
        required: false
        default: 'true'

env:
  PYTHON_VERSION: '3.13'

jobs:
  rc-validation:
    name: "Validate RC Criteria"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run RC E2E validation
        id: validate
        run: |
          echo "Starting Phase 7.0-RC validation..."
          python scripts/validate_rc_e2e.py | tee rc_validation.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "result=PASS" >> $GITHUB_OUTPUT
          else
            echo "result=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Extract metrics from attestation
        if: always()
        id: metrics
        run: |
          if [ -f attest/phase-7.0-rc_e2e_validation.json ]; then
            MEMORY=$(jq -r '.memory_resonance.stability' attest/phase-7.0-rc_e2e_validation.json)
            RIS=$(jq -r '.ris.score' attest/phase-7.0-rc_e2e_validation.json)
            STRESS=$(jq -r '.stress_resilience.recovery_rate' attest/phase-7.0-rc_e2e_validation.json)
            OVERALL=$(jq -r '.rc_criteria.overall_pass' attest/phase-7.0-rc_e2e_validation.json)
            HASH=$(jq -r '.attestation_hash' attest/phase-7.0-rc_e2e_validation.json | cut -c1-16)

            echo "memory_stability=$MEMORY" >> $GITHUB_OUTPUT
            echo "ris_score=$RIS" >> $GITHUB_OUTPUT
            echo "stress_recovery=$STRESS" >> $GITHUB_OUTPUT
            echo "overall_pass=$OVERALL" >> $GITHUB_OUTPUT
            echo "hash=$HASH" >> $GITHUB_OUTPUT
          else
            echo "memory_stability=N/A" >> $GITHUB_OUTPUT
            echo "ris_score=N/A" >> $GITHUB_OUTPUT
            echo "stress_recovery=N/A" >> $GITHUB_OUTPUT
            echo "overall_pass=false" >> $GITHUB_OUTPUT
            echo "hash=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Generate validation summary
        if: always()
        run: |
          MEMORY="${{ steps.metrics.outputs.memory_stability }}"
          RIS="${{ steps.metrics.outputs.ris_score }}"
          STRESS="${{ steps.metrics.outputs.stress_recovery }}"
          OVERALL="${{ steps.metrics.outputs.overall_pass }}"
          RESULT="${{ steps.validate.outputs.result }}"

          # Determine status icons
          if [ "$MEMORY" != "N/A" ] && (( $(echo "$MEMORY >= 0.80" | bc -l) )); then
            MEM_STATUS="✅"
          else
            MEM_STATUS="❌"
          fi

          if [ "$RIS" != "N/A" ] && (( $(echo "$RIS >= 0.75" | bc -l) )); then
            RIS_STATUS="✅"
          else
            RIS_STATUS="❌"
          fi

          if [ "$STRESS" != "N/A" ] && (( $(echo "$STRESS >= 0.90" | bc -l) )); then
            STRESS_STATUS="✅"
          else
            STRESS_STATUS="❌"
          fi

          if [ "$OVERALL" = "true" ]; then
            OVERALL_STATUS="✅ PASS"
          else
            OVERALL_STATUS="❌ FAIL"
          fi

          cat <<EOF > $GITHUB_STEP_SUMMARY
          # Phase 7.0-RC Validation Results

          **Overall Status:** $OVERALL_STATUS

          ## RC Criteria

          | Metric | Value | Threshold | Status |
          |--------|-------|-----------|--------|
          | Memory Stability | $MEMORY | ≥ 0.80 | $MEM_STATUS |
          | RIS Score | $RIS | ≥ 0.75 | $RIS_STATUS |
          | Stress Recovery | $STRESS | ≥ 0.90 | $STRESS_STATUS |

          ## Attestation

          - **File:** \`attest/phase-7.0-rc_e2e_validation.json\`
          - **Hash:** \`${{ steps.metrics.outputs.hash }}...\`
          - **Signature:** "The sun shines on this work."

          ## Next Steps

          $( [ "$OVERALL" = "true" ] && echo "✅ System ready for production promotion. Create tag \`v7.0-rc-complete\`." || echo "❌ RC criteria not met. Review metrics and re-validate." )
          EOF

      - name: Upload attestation artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase-7-rc-attestation-${{ github.run_id }}
          path: |
            attest/phase-7.0-rc_e2e_validation.json
            rc_validation.log
          retention-days: 90

      - name: Fail job if RC criteria not met
        if: steps.validate.outputs.exit_code != '0'
        run: |
          echo "::error::RC validation failed - criteria not met"
          exit 1
