name: Contracts Freeze
on:
  pull_request:
    branches: [ main ]

jobs:
  freeze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # Gate Slot 3 schema updates (extend the list below for other schemas)
      - name: Guard schema changes unless explicitly tagged
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          BASE: ${{ github.base_ref }}
        run: |
          set -e
          CHANGED=$(git diff --name-only origin/$BASE...HEAD -- \
            contracts/slot3_health_schema.json \
          || true)

          if [ -z "$CHANGED" ]; then
            echo "No guarded contract changes detected."
            exit 0
          fi

          echo "Detected guarded contract changes:"
          echo "$CHANGED"
          echo "Require 'CONTRACT:BUMP' or 'CONTRACT:EXPLAIN' in PR body."

          echo "$PR_BODY" | grep -qiE 'CONTRACT:(BUMP|EXPLAIN)' \
            && echo "Found contract note ✅" && exit 0

          echo "❌ Missing CONTRACT:BUMP/EXPLAIN tag in PR body."
          exit 1